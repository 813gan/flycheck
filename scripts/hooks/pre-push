#!/usr/bin/env python
# -*- coding: utf-8; -*-

from __future__ import print_function

import sys
import os
import subprocess


def log(message):
    print(message, file=sys.stderr, end='')


def run_tests(logfile):
    subprocess.check_call(['make', 'vagrant-test'], stdout=logfile,
                          stderr=subprocess.STDOUT, bufsize=0)


def build_docs(logfile):
    subprocess.check_call(['vagrant', 'ssh', '-c', 'make -C /flycheck doc'],
                          stdout=logfile, stderr=subprocess.STDOUT, bufsize=0)


def is_info_manual_current():
    output = subprocess.check_output(['git', 'status', '--porcelain',
                                      'doc/flycheck.texi'])
    return 'doc/flycheck.texi' not in output


def main():
    testlog = os.path.abspath('testlog')
    for line in sys.stdin:
        _, _, remote_ref, _ = line.split()
        if remote_ref != 'refs/heads/master':
            # Don't force tests on feature branches
            continue
        log('Pushing to master!\n')
        success = True
        # Disable buffering, to support tail -f logfile
        with open(testlog, 'wb', buffering=1) as logfile:
            for message, action in [('Running tests', run_tests),
                                    ('Building docs', build_docs)]:
                log(message)
                log('...')
                try:
                    action(logfile)
                    log(' ok\n')
                except subprocess.CalledProcessError:
                    log(' FAILED\n')
                    success = False
        if not success:
            log('Failures occurred, see {0} for details\n'.format(testlog))
            return 1
        else:
            # Remove the logfile if no errors occurred
            os.unlink(testlog)

        if not is_info_manual_current():
            log('Info manual not current.  Please commit doc/flycheck.texi!\n')
            return 1
    return 0


if __name__ == '__main__':
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        log('Interrupted, not finishing push\n')
